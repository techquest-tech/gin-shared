package schedule

import (
	"context"
	"errors"

	"github.com/robfig/cron/v3"
	"github.com/techquest-tech/gin-shared/pkg/locker"
	"go.uber.org/zap"
)

// Deprecated: ScheduleLoker is deprecated. Use CreateScheduledJob instead.
type ScheduleLoker struct {
	Locker  locker.Locker
	Jobname string
}

var errlockerFailed = errors.New("get locker failed")

// Deprecated: Wrapper is deprecated. Use CreateScheduledJob instead.
func (sl *ScheduleLoker) Wrapper() cron.JobWrapper {
	return func(j cron.Job) cron.Job {
		return cron.FuncJob(func() {
			ctx := context.TODO()
			// startAt := time.Now()
			logger := zap.L().With(zap.String("Jobname", sl.Jobname))
			// logger.Debug("try to get locker", zap.String("locker", fmt.Sprintf("%T", sl.Locker)))
			release, err := sl.Locker.LockWithtimeout(ctx, sl.Jobname, LockerTimeout)
			if err != nil {
				logger.Info("get locker failed. job cancel.", zap.Error(err))
				// panic(errlockerFailed)
				return
			}
			defer release(ctx)
			// logger.Debug("got locker")
			j.Run()
			// dur := time.Since(startAt)
			// logger.Info("job done.", zap.Duration("duration", dur))
		})
	}
}
